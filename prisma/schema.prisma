generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model ComponentGeometry {
  id         String      @id @default(uuid())
  position   Json
  indices    Json
  components Component[] @relation("ComponentToGeometry")
}

model Component {
  id            String              @id @default(uuid())
  name          String
  geometry      ComponentGeometry[] @relation("ComponentToGeometry")
  psets         Json
  libraries     Library[]           @relation("ComponentToLibrary")
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  User          User?               @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId        String
  author        String
  public        Boolean             @default(true)
  nodes         NodeProject?        @relation("NodeProjectToComponent")
  nodeProjectId String?             @unique
}

model NodeProject {
  id          String     @id @default(uuid())
  nodes       Json
  edges       Json
  componentId String     @unique
  Component   Component? @relation("NodeProjectToComponent", fields: [componentId], references: [id], onDelete: Cascade)
}

model Library {
  id                 String             @id @default(uuid())
  name               String
  description        String
  Components         Component[]        @relation("ComponentToLibrary")
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  author             User               @relation("AuthorOfLibrary", fields: [userId], references: [id], onDelete: Cascade)
  userId             String
  guests             User[]             @relation("LibraryGuests")
  public             Boolean            @default(true)
  sharedId           String?
  CompositeLibraries CompositeLibrary[] @relation("CompositeLibrary")
}

model User {
  id         String  @id @default(uuid())
  clerkId    String  @unique
  firstName  String
  secondName String?
  premium    Boolean @default(false)

  authoredLibraries Library[] @relation("AuthorOfLibrary")
  guestLibraries    Library[] @relation("LibraryGuests")

  Components Component[]

  guestCompositeLibraries    CompositeLibrary[] @relation("CompositeLibraryGuests")
  authoredCompositeLibraries CompositeLibrary[] @relation("AuthorOfCompositeLibrary")
}

model CompositeLibrary {
  id          String    @id @default(uuid())
  name        String
  description String
  Libraries   Library[] @relation("CompositeLibrary")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  guests      User[]    @relation("CompositeLibraryGuests")
  author      User      @relation("AuthorOfCompositeLibrary", fields: [userId], references: [id], onDelete: Cascade)
  userId      String
  public      Boolean
  sharedId    String?
}

model HistoryEntry {
  id           String      @id @default(uuid())
  createdAt    DateTime    @default(now())
  actionName   String
  HistoryLog   HistoryLog? @relation(fields: [historyLogId], references: [id])
  historyLogId String?
}

model HistoryLog {
  id      String         @id @default(uuid())
  entries HistoryEntry[]
}
